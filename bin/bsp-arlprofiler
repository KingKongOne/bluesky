#! /usr/bin/env python

__author__ = "Joel Dubowy"
__copyright__ = "Copyright 2015, AirFire, PNW, USFS"

import json
import logging
import sys
import traceback
import tornado.ioloop

from pyairfire import scripting

try:
    from bluesky.met import arlprofiler
except:
    import os
    import sys
    root_dir = os.path.abspath(os.path.join(sys.path[0], '../'))
    sys.path.insert(0, root_dir)
    from bluesky.met import arlprofiler

class ParseArlFilesAction(Action):

    KEY_VALUE_EXTRACTER = re.compile('^([^=]+)=([^=]+)$')

    def __call__(self, parser, namespace, value, option_string=None):
        """Splits value into key/value, and set in destination dict

        Note: Expects value to be of the format 'key=value'.  Also expects
        destination (i.e. parser.value's self.dest attribute), to be
        initialized as an empty dict.
        """
        m = value.split(';')
        if len(m) != 3:
            msg = "Invalid value '{}' for option '{}' - value must be of the "
                "form '<file>;<start>;<end>'".format(value, opt)
            raise scripting.args.ArgumentTypeError(msg)
        d = getattr(namespace, self.dest)
        d = d or []
        d.append({"file": m[0], "start": m[1], "start": m[2]})

REQUIRED_ARGS = [
    {
        'short': '-f',
        'long': '--met-file',
        'dest': 'met_files',
        'help': 'Met file with date range to use it for; format "<file>;<start>;<end>"',
        'action': ParseDatetimeAction
    },
    {
        'short': '-s',
        'long': '--start',
        'dest': 'start',
        'help': 'start datetime',
        'action': scripting.args.ParseDatetimeAction
    },
    {
        'short': '-e',
        'long': '--end',
        'dest': 'end',
        'help': 'end datetime',
        'action': scripting.args.ParseDatetimeAction
    },
    {
        'short': '-l',
        'long': '--lat',
        'dest': 'lat',
        'help': 'latitude',
        'action': 'store',
        'type': float
    },
    {
        'short': '-g',
        'long': '--lng',
        'dest': 'lng',
        'help': 'longitude',
        'action': 'store',
        'type': float
    }

]
OPTIONAL_ARGS = [
    {
        'short': '-p',
        'long': '--profile-exe',
        'dest': 'profile_exe',
        'help': 'Profile executable',
        'action': 'store'
    },
    {
        'short': '-t',
        'long': '--time_step',
        'dest': 'time_step',
        'help': 'Time step',
        'action': 'store',
        'type': int
    }
]

EXAMPLES_STR = """Examples:
  $ PATH=~/path/to/profile/exe/dir/:$PATH \\
     ./bin/bsp-arlprofiler -d /DRI_6km/ \\
     -s 2014-05-29T20:00:00 -e 2014-05-30T00:00:00 \\
     -l 37 -g -121
"""

if __name__ == "__main__":
    parser, args = scripting.args.parse_args(REQUIRED_ARGS, OPTIONAL_ARGS,
        epilog=EXAMPLES_STR)
    try:
        profiler = arlprofiler.ArlProfiler(args.met_files,
            profile_exe=args.profile_exe)
        sys.stdout.write(json.dumps(profiler.profile(args.start, args.end,
            args.lat, args.lng)))
    except Exception, e:
        logging.error(e)
        logging.debug(traceback.format_exc())
        scripting.utils.exit_with_msg(e)
