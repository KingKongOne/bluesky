#!/usr/bin/env bash

show_help=false
no_prompts=false

while [ -n "$1" ]; do # while loop starts
    case "$1" in
    -h) show_help=true && shift ;;
    --help) show_help=true && shift ;;
    --no-prompts) no_prompts=true && shift ;;
    *) echo "Option $1 not recognized" && exit 1 ;;
    esac
done

if [ "$show_help" = true ] ; then
    echo ""
    echo "Options:"
    echo "   -h/--help     - show this help message"
    echo "   --no-prompts  - Don't prompt to continue after each run"
    echo ""
    echo "Usage:"
    echo "   $0"
    echo "   $0 --no-prompts"
    echo ""
    exit 0
fi

DIR=`dirname $0`
DIR=`python -c "import os;print(os.path.abspath('$DIR'))"`
echo "Script dir: $DIR"

REPO_DIR=`python -c "import os;print(os.path.abspath('$DIR/../../../'))"`
echo "Repo dir: $REPO_DIR"


prompt_to_continue () {
    if [ "$no_prompts" = false ] ; then
        read -p "Do you want to continue? [yN]: " -r
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "*** ABORTING."
            exit 1
        fi
        echo "Continuing...."
    fi
}

check_return_code () {
    if [ $? -ne 0 ]; then
        echo "*** Bluesky run FAILED."
        echo "*** ABORTING."
        exit 1
    fi
    prompt_to_continue
}

echo "Running 2014-05-29, 1 Fire, writing pardump file"
docker run --rm -ti -v $DIR/:/data/ -v $HOME/Met/:/Met/ \
    -v $REPO_DIR/:/bluesky/ -e PYTHONPATH=/bluesky/ \
    -e PATH=/bluesky/bin/:$PATH bluesky bsp --log-level DEBUG \
    --today=2014-05-29 \
    --log-file /data/output-2014-05-29-pardump-1F.log \
    -i /data/one-fire-2014-05-29.json \
    -o /data/output-2014-05-29-pardump-1F.json \
    -c /data/config.json \
    -C plumerising.feps.working_dir=/data/working/plumerising/2014-05-29-pardump-1F/ \
    -C dispersion.output_dir=/data/output/2014-05-29-pardump-1F/ \
    -C dispersion.working_dir=/data/working/dispersion/2014-05-29-pardump-1F/ \
    -B dispersion.hysplit.MAKE_INIT_FILE=true \
    -I dispersion.hysplit.NDUMP=24 \
    -I dispersion.hysplit.NCYCL=0 \
    -C dispersion.hysplit.PARDUMP=/data/particlefiles/pardump-{today:%Y-%m-%d}-1F \
    ingestion fuelbeds consumption emissions \
    timeprofiling findmetdata localmet plumerising \
    dispersion visualization
check_return_code

echo "Running 2014-05-29, 2 Fires, writing pardump file"
docker run --rm -ti -v $DIR/:/data/ -v $HOME/Met/:/Met/ \
    -v $REPO_DIR/:/bluesky/ -e PYTHONPATH=/bluesky/ \
    -e PATH=/bluesky/bin/:$PATH bluesky bsp --log-level DEBUG \
    --today=2014-05-29 \
    --log-file /data/output-2014-05-29-pardump-2F.log \
    -i /data/one-fire-2014-05-29.json \
    -o /data/output-2014-05-29-pardump-2F.json \
    -c /data/config.json \
    -C plumerising.feps.working_dir=/data/working/plumerising/2014-05-29-pardump-2F/ \
    -C dispersion.output_dir=/data/output/2014-05-29-pardump-2F/ \
    -C dispersion.working_dir=/data/working/dispersion/2014-05-29-pardump-2F/ \
    -B dispersion.hysplit.MAKE_INIT_FILE=true \
    -I dispersion.hysplit.NDUMP=24 \
    -I dispersion.hysplit.NCYCL=0 \
    -C dispersion.hysplit.PARDUMP=/data/particlefiles/pardump-{today:%Y-%m-%d}-2F \
    ingestion fuelbeds consumption emissions \
    timeprofiling findmetdata localmet plumerising \
    dispersion visualization
check_return_code

echo "Running 2014-05-30, 2 Fires, Reading pardump file from 1 fire run"
docker run --rm -ti -v $DIR/:/data/ -v $HOME/Met/:/Met/ \
    -v $REPO_DIR/:/bluesky/ -e PYTHONPATH=/bluesky/ \
    -e PATH=/bluesky/bin/:$PATH bluesky bsp --log-level DEBUG \
    --today=2014-05-30 \
    --log-file /data/output-2014-05-30-parinit-2F-from-1F.log \
    -i /data/2-fires-2014-05-30.json \
    -o /data/output-2014-05-30-parinit-2F-from-1F.json \
    -c /data/config.json \
    -C plumerising.feps.working_dir=/data/working/plumerising/2014-05-30-parinit-2F-from-1F/ \
    -C dispersion.output_dir=/data/output/2014-05-30-parinit-2F-from-1F/ \
    -C dispersion.working_dir=/data/working/dispersion/2014-05-30-parinit-2F-from-1F/ \
    -I dispersion.hysplit.NINIT=1 \
    -C dispersion.hysplit.PARINIT=/data/particlefiles/pardump-{today-1:%Y-%m-%d}-1F \
    ingestion fuelbeds consumption emissions \
    timeprofiling findmetdata localmet plumerising \
    dispersion visualization
check_return_code


echo "Running 2014-05-30, 2 Fires, Reading pardump file from 2 fire run"
docker run --rm -ti -v $DIR/:/data/ -v $HOME/Met/:/Met/ \
    -v $REPO_DIR/:/bluesky/ -e PYTHONPATH=/bluesky/ \
    -e PATH=/bluesky/bin/:$PATH bluesky bsp --log-level DEBUG \
    --today=2014-05-30 \
    --log-file /data/output-2014-05-30-parinit-2F-from-2F.log \
    -i /data/2-fires-2014-05-30.json \
    -o /data/output-2014-05-30-parinit-2F-from-2F.json \
    -c /data/config.json \
    -C plumerising.feps.working_dir=/data/working/plumerising/2014-05-30-parinit-2F-from-2F/ \
    -C dispersion.output_dir=/data/output/2014-05-30-parinit-2F-from-2F/ \
    -C dispersion.working_dir=/data/working/dispersion/2014-05-30-parinit-2F-from-2F/ \
    -I dispersion.hysplit.NINIT=1 \
    -C dispersion.hysplit.PARINIT=/data/particlefiles/pardump-{today-1:%Y-%m-%d}-2F \
    ingestion fuelbeds consumption emissions \
    timeprofiling findmetdata localmet plumerising \
    dispersion visualization
check_return_code


echo "Running 2014-05-30, 1 Fire, Reading pardump file from 1 fire run"
docker run --rm -ti -v $DIR/:/data/ -v $HOME/Met/:/Met/ \
    -v $REPO_DIR/:/bluesky/ -e PYTHONPATH=/bluesky/ \
    -e PATH=/bluesky/bin/:$PATH bluesky bsp --log-level DEBUG \
    --today=2014-05-30 \
    --log-file /data/output-2014-05-30-parinit-1F-from-1F.log \
    -i /data/1-fire-2014-05-30.json \
    -o /data/output-2014-05-30-parinit-1F-from-1F.json \
    -c /data/config.json \
    -C plumerising.feps.working_dir=/data/working/plumerising/2014-05-30-parinit-1F-from-1F/ \
    -C dispersion.output_dir=/data/output/2014-05-30-parinit-1F-from-1F/ \
    -C dispersion.working_dir=/data/working/dispersion/2014-05-30-parinit-1F-from-1F/ \
    -I dispersion.hysplit.NINIT=1 \
    -C dispersion.hysplit.PARINIT=/data/particlefiles/pardump-{today-1:%Y-%m-%d}-1F \
    ingestion fuelbeds consumption emissions \
    timeprofiling findmetdata localmet plumerising \
    dispersion visualization
check_return_code


echo "Running 2014-05-30, 1 Fire, Reading pardump file from 2 fire run"
docker run --rm -ti -v $DIR/:/data/ -v $HOME/Met/:/Met/ \
    -v $REPO_DIR/:/bluesky/ -e PYTHONPATH=/bluesky/ \
    -e PATH=/bluesky/bin/:$PATH bluesky bsp --log-level DEBUG \
    --today=2014-05-30 \
    --log-file /data/output-2014-05-30-parinit-1F-from-2F.log \
    -i /data/1-fire-2014-05-30.json \
    -o /data/output-2014-05-30-parinit-1F-from-2F.json \
    -c /data/config.json \
    -C plumerising.feps.working_dir=/data/working/plumerising/2014-05-30-parinit-1F-from-2F/ \
    -C dispersion.output_dir=/data/output/2014-05-30-parinit-1F-from-2F/ \
    -C dispersion.working_dir=/data/working/dispersion/2014-05-30-parinit-1F-from-2F/ \
    -I dispersion.hysplit.NINIT=1 \
    -C dispersion.hysplit.PARINIT=/data/particlefiles/pardump-{today-1:%Y-%m-%d}-2F \
    ingestion fuelbeds consumption emissions \
    timeprofiling findmetdata localmet plumerising \
    dispersion visualization
check_return_code

echo "Running 2014-05-30, 2 Fires, No parinit"
docker run --rm -ti -v $DIR/:/data/ -v $HOME/Met/:/Met/ \
    -v $REPO_DIR/:/bluesky/ -e PYTHONPATH=/bluesky/ \
    -e PATH=/bluesky/bin/:$PATH bluesky bsp --log-level DEBUG \
    --today=2014-05-30 \
    --log-file /data/output-2014-05-30-noparinit-1F.log \
    -i /data/input-2014-05-30-noparinit-1F.json \
    -o /data/output-2014-05-30-noparinit-1F.json \
    -c /data/config.json \
    -C plumerising.feps.working_dir=/data/working/plumerising/2014-05-30-noparinit-1F/ \
    -C dispersion.output_dir=/data/output/2014-05-30-noparinit-1F/ \
    -C dispersion.working_dir=/data/working/dispersion/2014-05-30-noparinit-1F/ \
    -C dispersion.hysplit.NINIT=0 \
    ingestion fuelbeds consumption emissions \
    timeprofiling findmetdata localmet plumerising \
    dispersion visualization
check_return_code

echo "Running 2014-05-30, 1 Fire, No parinit"
docker run --rm -ti -v $DIR/:/data/ -v $HOME/Met/:/Met/ \
    -v $REPO_DIR/:/bluesky/ -e PYTHONPATH=/bluesky/ \
    -e PATH=/bluesky/bin/:$PATH bluesky bsp --log-level DEBUG \
    --today=2014-05-30 \
    --log-file /data/output-2014-05-30-noparinit-2F.log \
    -i /data/input-2014-05-30-noparinit-2F.json \
    -o /data/output-2014-05-30-noparinit-2F.json \
    -c /data/config.json \
    -C plumerising.feps.working_dir=/data/working/plumerising/2014-05-30-noparinit-2F/ \
    -C dispersion.output_dir=/data/output/2014-05-30-noparinit-2F/ \
    -C dispersion.working_dir=/data/working/dispersion/2014-05-30-noparinit-2F/ \
    -C dispersion.hysplit.NINIT=0 \
    ingestion fuelbeds consumption emissions \
    timeprofiling findmetdata localmet plumerising \
    dispersion visualization
check_return_code


# TODO:
#   - make sure num_processes was 2 each run
#   - make sure dummy fire was filled in for first day
#   - ...